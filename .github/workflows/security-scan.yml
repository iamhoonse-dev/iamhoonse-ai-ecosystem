name: Security Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sundays

jobs:
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript', 'typescript' ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"

  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        run: pnpm audit --audit-level high

      - name: Check for known vulnerabilities
        run: |
          if command -v audit-ci &> /dev/null; then
            npx audit-ci --config audit-ci.json
          else
            echo "audit-ci not installed, skipping detailed vulnerability check"
          fi
        continue-on-error: true

  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

  security-report:
    name: Security Report
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [codeql-analysis, dependency-scan, secret-scan]
    
    steps:
      - name: Generate security summary
        uses: actions/github-script@v7
        with:
          script: |
            // Create security report for PR comment
            let securityReport = `## ğŸ›¡ï¸ ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼\n\n`;
            securityReport += `**ìŠ¤ìº” ëŒ€ìƒ:** \`${context.payload.pull_request.head.ref}\` ë¸Œëœì¹˜\n`;
            securityReport += `**ìŠ¤ìº” ì‹œê°„:** ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}\n\n`;
            
            // Check job statuses
            const jobs = ['codeql-analysis', 'dependency-scan', 'secret-scan'];
            const jobResults = {};
            
            try {
              // Get workflow run for this PR
              const { data: runs } = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'security-scan.yml',
                head_sha: context.payload.pull_request.head.sha
              });
              
              if (runs.workflow_runs.length > 0) {
                const runId = runs.workflow_runs[0].id;
                const { data: runJobs } = await github.rest.actions.listJobsForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: runId
                });
                
                for (const job of runJobs.jobs) {
                  jobResults[job.name] = {
                    status: job.status,
                    conclusion: job.conclusion,
                    html_url: job.html_url
                  };
                }
              }
            } catch (error) {
              console.error('Error fetching job results:', error);
            }
            
            // CodeQL Analysis
            securityReport += `### ğŸ” CodeQL ì •ì  ë¶„ì„\n`;
            const codeqlResult = jobResults['CodeQL Analysis'];
            if (codeqlResult) {
              const emoji = codeqlResult.conclusion === 'success' ? 'âœ…' : 
                           codeqlResult.conclusion === 'failure' ? 'âŒ' : 'ğŸ”„';
              securityReport += `- **ìƒíƒœ:** ${emoji} ${codeqlResult.conclusion || codeqlResult.status}\n`;
              securityReport += `- **ë¶„ì„ ì–¸ì–´:** JavaScript, TypeScript\n`;
              securityReport += `- **ë¡œê·¸:** [CodeQL ë¶„ì„ ê²°ê³¼ ë³´ê¸°](${codeqlResult.html_url})\n`;
              
              if (codeqlResult.conclusion === 'success') {
                securityReport += `- **ê²°ê³¼:** ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤\n`;
              } else if (codeqlResult.conclusion === 'failure') {
                securityReport += `- **ê²°ê³¼:** ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìƒì„¸ ê²°ê³¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”\n`;
              }
            } else {
              securityReport += `- **ìƒíƒœ:** â­ï¸ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ\n`;
            }
            
            // Dependency Scan
            securityReport += `\n### ğŸ“¦ ì˜ì¡´ì„± ë³´ì•ˆ ìŠ¤ìº”\n`;
            const depResult = jobResults['Dependency Security Scan'];
            if (depResult) {
              const emoji = depResult.conclusion === 'success' ? 'âœ…' : 
                           depResult.conclusion === 'failure' ? 'âŒ' : 'ğŸ”„';
              securityReport += `- **ìƒíƒœ:** ${emoji} ${depResult.conclusion || depResult.status}\n`;
              securityReport += `- **ê²€ì‚¬ ë„êµ¬:** pnpm audit, audit-ci\n`;
              securityReport += `- **ë¡œê·¸:** [ì˜ì¡´ì„± ìŠ¤ìº” ê²°ê³¼ ë³´ê¸°](${depResult.html_url})\n`;
              
              if (depResult.conclusion === 'success') {
                securityReport += `- **ê²°ê³¼:** ê³ ìœ„í—˜ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤\n`;
              } else if (depResult.conclusion === 'failure') {
                securityReport += `- **ê²°ê³¼:** ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤\n`;
              }
            } else {
              securityReport += `- **ìƒíƒœ:** â­ï¸ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ\n`;
            }
            
            // Secret Scan
            securityReport += `\n### ğŸ” ì‹œí¬ë¦¿ ìŠ¤ìº”\n`;
            const secretResult = jobResults['Secret Scanning'];
            if (secretResult) {
              const emoji = secretResult.conclusion === 'success' ? 'âœ…' : 
                           secretResult.conclusion === 'failure' ? 'âŒ' : 'ğŸ”„';
              securityReport += `- **ìƒíƒœ:** ${emoji} ${secretResult.conclusion || secretResult.status}\n`;
              securityReport += `- **ê²€ì‚¬ ë„êµ¬:** TruffleHog OSS\n`;
              securityReport += `- **ë¡œê·¸:** [ì‹œí¬ë¦¿ ìŠ¤ìº” ê²°ê³¼ ë³´ê¸°](${secretResult.html_url})\n`;
              
              if (secretResult.conclusion === 'success') {
                securityReport += `- **ê²°ê³¼:** í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤\n`;
              } else if (secretResult.conclusion === 'failure') {
                securityReport += `- **ê²°ê³¼:** ì ì¬ì  ì‹œí¬ë¦¿ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤\n`;
              }
            } else {
              securityReport += `- **ìƒíƒœ:** â­ï¸ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ\n`;
            }
            
            // Security recommendations
            securityReport += `\n### ğŸš¨ ë³´ì•ˆ ê¶Œì¥ì‚¬í•­\n`;
            securityReport += `- ëª¨ë“  ì˜ì¡´ì„±ì„ ìµœì‹  ë³´ì•ˆ íŒ¨ì¹˜ ë²„ì „ìœ¼ë¡œ ìœ ì§€í•˜ì„¸ìš”\n`;
            securityReport += `- API í‚¤, ë¹„ë°€ë²ˆí˜¸ ë“±ì€ í™˜ê²½ë³€ìˆ˜ë‚˜ ì‹œí¬ë¦¿ ë§¤ë‹ˆì €ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”\n`;
            securityReport += `- ì •ê¸°ì ìœ¼ë¡œ ë³´ì•ˆ ìŠ¤ìº”ì„ ì‹¤í–‰í•˜ì—¬ ìƒˆë¡œìš´ ì·¨ì•½ì ì„ í™•ì¸í•˜ì„¸ìš”\n`;
            securityReport += `- ì½”ë“œ ë¦¬ë·° ì‹œ ë³´ì•ˆ ê´€ì ì—ì„œì˜ ê²€í† ë¥¼ í¬í•¨í•˜ì„¸ìš”\n`;
            
            // Overall security status
            const hasFailures = Object.values(jobResults).some(r => r.conclusion === 'failure');
            const hasInProgress = Object.values(jobResults).some(r => r.status === 'in_progress' || r.status === 'queued');
            
            if (hasInProgress) {
              securityReport = `### ğŸ”„ ë³´ì•ˆ ìŠ¤ìº” ì§„í–‰ ì¤‘\nì¼ë¶€ ë³´ì•ˆ ê²€ì‚¬ê°€ ì•„ì§ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.\n\n` + securityReport;
            } else if (hasFailures) {
              securityReport = `### âŒ ë³´ì•ˆ ì´ìŠˆ ë°œê²¬\nì¼ë¶€ ë³´ì•ˆ ê²€ì‚¬ì—ì„œ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì¦‰ì‹œ í™•ì¸í•˜ì—¬ ì¡°ì¹˜í•´ì£¼ì„¸ìš”.\n\n` + securityReport;
            } else if (Object.keys(jobResults).length > 0) {
              securityReport = `### âœ… ë³´ì•ˆ ê²€ì‚¬ í†µê³¼\nëª¨ë“  ë³´ì•ˆ ê²€ì‚¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n` + securityReport;
            }
            
            // Find existing security comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const existingComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ›¡ï¸ ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼')
            );
            
            const commentBody = securityReport + '\n\n---\n*ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ëŠ” GitHub Actionsì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*';
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody
              });
              console.log('Updated existing security comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
              console.log('Created new security comment');
            }
        continue-on-error: true