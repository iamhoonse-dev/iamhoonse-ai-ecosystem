name: PR Quality Check

on:
  pull_request:
    branches: [ main ]

jobs:
  quality-check:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0
          
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Run ESLint
        run: pnpm lint
        
      - name: Check TypeScript types
        run: pnpm check-types
        
      - name: Check code formatting
        run: pnpm format:check
        
      - name: Build project
        run: pnpm build
        
      - name: Run tests
        run: pnpm test || echo "Tests not configured yet"
        continue-on-error: true
        
      - name: Security audit
        run: pnpm audit --audit-level moderate
        continue-on-error: true

      - name: Generate quality report
        if: matrix.node-version == '18.x'
        run: |
          # Create quality report for PR comment
          echo "## ğŸ“‹ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ê²°ê³¼" > quality-report.md
          echo "" >> quality-report.md
          echo "**Node.js ë²„ì „:** ${{ matrix.node-version }}" >> quality-report.md
          echo "" >> quality-report.md
          
          # ESLint results
          echo "### ğŸ” ESLint ê²€ì‚¬" >> quality-report.md
          if pnpm lint --format=json > eslint-results.json 2>/dev/null; then
            echo "- **ìƒíƒœ:** âœ… í†µê³¼" >> quality-report.md
            echo "- **ë¦°íŠ¸ ì˜¤ë¥˜:** 0ê°œ" >> quality-report.md
          else
            LINT_ERRORS=$(pnpm lint 2>&1 | grep -c "error" || echo "0")
            LINT_WARNINGS=$(pnpm lint 2>&1 | grep -c "warning" || echo "0")
            echo "- **ìƒíƒœ:** âŒ ì‹¤íŒ¨" >> quality-report.md
            echo "- **ë¦°íŠ¸ ì˜¤ë¥˜:** ${LINT_ERRORS}ê°œ" >> quality-report.md
            echo "- **ë¦°íŠ¸ ê²½ê³ :** ${LINT_WARNINGS}ê°œ" >> quality-report.md
          fi
          
          # TypeScript check results
          echo "" >> quality-report.md
          echo "### ğŸ“ TypeScript íƒ€ì… ê²€ì‚¬" >> quality-report.md
          if pnpm check-types > ts-results.txt 2>&1; then
            echo "- **ìƒíƒœ:** âœ… í†µê³¼" >> quality-report.md
            echo "- **íƒ€ì… ì˜¤ë¥˜:** 0ê°œ" >> quality-report.md
          else
            TS_ERRORS=$(cat ts-results.txt | grep -c "error" || echo "0")
            echo "- **ìƒíƒœ:** âŒ ì‹¤íŒ¨" >> quality-report.md
            echo "- **íƒ€ì… ì˜¤ë¥˜:** ${TS_ERRORS}ê°œ" >> quality-report.md
          fi
          
          # Format check results
          echo "" >> quality-report.md
          echo "### ğŸ¨ ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬" >> quality-report.md
          if pnpm format:check > format-results.txt 2>&1; then
            echo "- **ìƒíƒœ:** âœ… í†µê³¼" >> quality-report.md
            echo "- **í¬ë§·íŒ… ì´ìŠˆ:** 0ê°œ" >> quality-report.md
          else
            echo "- **ìƒíƒœ:** âŒ ì‹¤íŒ¨" >> quality-report.md
            echo "- **í¬ë§·íŒ… ì´ìŠˆ:** í¬ë§·íŒ…ì´ í•„ìš”í•œ íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤" >> quality-report.md
          fi
          
          # Build results
          echo "" >> quality-report.md
          echo "### ğŸ”¨ ë¹Œë“œ ê²€ì‚¬" >> quality-report.md
          if pnpm build > build-results.txt 2>&1; then
            echo "- **ìƒíƒœ:** âœ… ì„±ê³µ" >> quality-report.md
            echo "- **ë¹Œë“œ ì˜¤ë¥˜:** 0ê°œ" >> quality-report.md
            
            # Get build time if available
            if [ -f "build-results.txt" ]; then
              BUILD_TIME=$(grep -i "completed in" build-results.txt | head -1 || echo "")
              if [ ! -z "$BUILD_TIME" ]; then
                echo "- **ë¹Œë“œ ì‹œê°„:** $BUILD_TIME" >> quality-report.md
              fi
            fi
          else
            echo "- **ìƒíƒœ:** âŒ ì‹¤íŒ¨" >> quality-report.md
            echo "- **ë¹Œë“œ ì˜¤ë¥˜:** ë¹Œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ" >> quality-report.md
          fi
          
          # Security audit results
          echo "" >> quality-report.md
          echo "### ğŸ›¡ï¸ ë³´ì•ˆ ê°ì‚¬" >> quality-report.md
          if pnpm audit --audit-level moderate > audit-results.txt 2>&1; then
            echo "- **ìƒíƒœ:** âœ… í†µê³¼" >> quality-report.md
            echo "- **ë³´ì•ˆ ì·¨ì•½ì :** 0ê°œ (moderate ìˆ˜ì¤€ ì´ìƒ)" >> quality-report.md
          else
            VULN_COUNT=$(grep -c "vulnerabilities" audit-results.txt || echo "0")
            echo "- **ìƒíƒœ:** âš ï¸ ì£¼ì˜" >> quality-report.md
            echo "- **ë³´ì•ˆ ì·¨ì•½ì :** ë°œê²¬ë¨ (ìƒì„¸ ë‚´ìš©ì€ ë¡œê·¸ í™•ì¸)" >> quality-report.md
          fi
          
          echo "" >> quality-report.md
          echo "### ğŸ’¡ ê°œì„  ì œì•ˆ" >> quality-report.md
          echo "- ëª¨ë“  ë¦°íŠ¸ ì˜¤ë¥˜ì™€ ê²½ê³ ë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”" >> quality-report.md
          echo "- TypeScript strict ëª¨ë“œ ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤" >> quality-report.md
          echo "- ì¼ê´€ëœ ì½”ë“œ ìŠ¤íƒ€ì¼ì„ ìœ„í•´ Prettierë¥¼ í™œìš©í•´ì£¼ì„¸ìš”" >> quality-report.md
          echo "- ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ëœ ê²½ìš° ì¦‰ì‹œ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”" >> quality-report.md
        continue-on-error: true

      - name: Comment quality results
        if: matrix.node-version == '18.x' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let qualityReport = '';
            try {
              qualityReport = fs.readFileSync('quality-report.md', 'utf8');
            } catch (error) {
              qualityReport = 'ğŸ“‹ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ë¹Œë“œ ë¡œê·¸ì—ì„œ ì„¸ë¶€ ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
            }
            
            // Find existing quality comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const existingComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ“‹ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ê²°ê³¼')
            );
            
            const commentBody = qualityReport + '\n\n---\n*í’ˆì§ˆ ê²€ì‚¬ ê²°ê³¼ëŠ” GitHub Actionsì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*';
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }
        continue-on-error: true